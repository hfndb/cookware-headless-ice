{"version":3,"sources":["javascript.ts"],"names":["JavascriptUtils","getOutputDir","cfg","AppConfig","getInstance","log","Logger","outputDir","dirProject","options","javascript","dirs","output","error","bundle","logging","nodeExec","dirMain","execPath","outDir","retVal","bundles","length","apps","i","items","outfile","push","source","forEach","item","to","info","cmd","process","env","NODE_ENV","cleanup","file","generateJsDocs","dependencies","jsdoc","config","dir","opts","destination","include","FileUtils","writeJsonFile","dirTemp","mkdir","async"],"mappings":"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","sourcesContent":["import { join } from \"path\";\nimport { cat, exec, rm, test } from \"shelljs\";\nimport { AppConfig, FileUtils, Logger } from \"../lib\";\n\nexport class JavascriptUtils {\n\t/**\n\t * Get HTML output directory\n\t */\n\tstatic getOutputDir(): string {\n\t\tlet cfg = AppConfig.getInstance();\n\t\tlet log = Logger.getInstance();\n\t\tlet outputDir = \"\";\n\t\tif (test(\"-d\", join(cfg.dirProject, cfg.options.javascript.dirs.output))) {\n\t\t\t// In case of local project\n\t\t\toutputDir = join(cfg.dirProject, cfg.options.javascript.dirs.output);\n\t\t} else if (test(\"-d\", cfg.options.javascript.dirs.output)) {\n\t\t\t// In case of hosting\n\t\t\toutputDir = cfg.options.javascript.dirs.output;\n\t\t} else {\n\t\t\tlog.error(\"JavaScript output directory couldn't be determined\");\n\t\t}\n\n\t\treturn outputDir;\n\t}\n\n\t/**\n\t * Create minified JavaScript bundles\n\t *\n\t * @returns array with output files\n\t */\n\tstatic bundle(): string[] {\n\t\tlet cfg = AppConfig.getInstance();\n\t\tlet log = Logger.getInstance(cfg.options.logging);\n\t\tlet nodeExec = join(cfg.dirMain, \"node_modules\", \"node\", \"bin\", \"node\");\n\t\tlet execPath = join(cfg.dirMain, \"dist\", \"static\", \"js\", \"local\");\n\t\tlet outDir = JavascriptUtils.getOutputDir();\n\t\tlet retVal: string[] = [];\n\n\t\tif (\n\t\t\tcfg.options.javascript.bundles.length == 0 &&\n\t\t\tcfg.options.javascript.apps.length == 0\n\t\t) {\n\t\t\treturn retVal;\n\t\t}\n\n\t\t// Generate bundles\n\t\tfor (let i = 0; i < cfg.options.javascript.bundles.length; i++) {\n\t\t\tlet bundle = cfg.options.javascript.apps[i];\n\t\t\tlet items: string[] = [];\n\t\t\tlet outfile = join(outDir, bundle.output);\n\t\t\tretVal.push(bundle.output);\n\t\t\trm(\"-f\", outfile);\n\n\t\t\tbundle.source.forEach((item: string) => {\n\t\t\t\titems.push(join(outDir, item));\n\t\t\t});\n\t\t\tcat(items).to(outfile);\n\n\t\t\tlog.info(`Written Javascript bundle ${bundle.output}`);\n\t\t}\n\n\t\t// Generate apps\n\t\tfor (let i = 0; i < cfg.options.javascript.apps.length; i++) {\n\t\t\tlet bundle = cfg.options.javascript.apps[i];\n\t\t\tlet outfile = join(outDir, bundle.output);\n\t\t\tretVal.push(bundle.output);\n\t\t\trm(\"-f\", outfile);\n\n\t\t\tlet cmd =\n\t\t\t\t`${nodeExec} ${join(execPath, \"create-app.js\")} ${cfg.dirProject}` +\n\t\t\t\t` ${i}`;\n\t\t\tif (process.env.NODE_ENV == \"production\") {\n\t\t\t\tcmd += \" 1\";\n\t\t\t}\n\t\t\texec(cmd);\n\n\t\t\t// Cleanup obsolete directories and files\n\t\t\tfor (let i = 0; bundle.cleanup && i < bundle.cleanup.length; i++) {\n\t\t\t\tlet file = join(outDir, bundle.cleanup[i]);\n\t\t\t\tif (test(\"-e\", file)) rm(\"-rf\", file); // Could be directory\n\t\t\t\tfile += \".map\";\n\t\t\t\tif (test(\"-e\", file)) rm(file); // Related source map\n\t\t\t}\n\t\t}\n\n\t\treturn retVal;\n\t}\n}\n\n/**\n * Generate HTML formatted docs from JavaScript sources in src.\n * Uses configuration in config.json\n */\nexport function generateJsDocs(): void {\n\tlet cfg = AppConfig.getInstance();\n\tlet log = Logger.getInstance(cfg.options.logging);\n\n\t// Make paths relative to project directory\n\tlet options: any = cfg.options.dependencies.jsdoc.config;\n\tlet dir = options.opts.destination;\n\toptions.opts.destination = join(cfg.dirProject, dir);\n\n\tfor (let i = 0; i < options.source.include.length; i++) {\n\t\toptions.source.include[i] = join(cfg.dirProject, options.source.include[i]);\n\t}\n\n\t// Write temp version of config\n\tFileUtils.writeJsonFile(options, cfg.dirTemp, \".jsdoc.json\", false);\n\n\t// Create or clean output directory\n\tif (test(\"-d\", options.opts.destination)) {\n\t\trm(\"-rf\", join(options.opts.destination, \"*\"));\n\t} else {\n\t\tFileUtils.mkdir(options.opts.destination);\n\t}\n\n\tlog.info(`Generating API docs of JavaScript files, in ${dir}`);\n\texec(`jsdoc --configure ${join(cfg.dirTemp, \".jsdoc.json\")}`, { async: true });\n}\n"]}
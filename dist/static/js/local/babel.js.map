{"version":3,"sources":["babel.ts"],"names":["compile","verbose","cfg","AppConfig","getInstance","log","Logger","options","logging","outDir","JavascriptUtils","getOutputDir","saydHello","session","SessionVars","sourceExt","javascript","compiler","ProcessingTypes","typescript","path","dirProject","dirs","source","warn","write","entry","info","compileFile","changeList","sourcePath","targetPath","targetExt","excludeList","removeObsolete","exclude","processed","forEach","push","target","isNewOrModified","add","bundle","file","Tags","forProject","forFile","fullPath","dir","plugins","presets","FileUtils","readFile","server","beautify","includes","Beautify","content","writeFile","process","env","NODE_ENV","sourceMapping","targets","browserTargets","node","nodeVersion","results","ast","comments","filename","sourceMaps","Error","fl","targetDir","code","JSON","stringify","map","err","error2string"],"mappings":"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","sourcesContent":["import { basename, dirname, join } from \"path\";\nimport { exec, rm, test } from \"shelljs\";\nimport { transformSync } from \"@babel/core\";\nimport {\n\tgetChangeList,\n\tAppConfig,\n\tFileStatus,\n\tFileUtils,\n\tLogger\n} from \"../lib\";\nimport { removeObsolete } from \"../lib/files\";\nimport { Beautify } from \"../lib/beautify\";\nimport { ProcessingTypes, SessionVars } from \"../sys/session\";\nimport { JavascriptUtils } from \"./javascript\";\nimport { Tags } from \"./tags\";\n\n// https://babeljs.io/docs/en/\n\n/**\n * Compile changed or new files, create browser bundles\n */\nexport function compile(verbose: boolean): void {\n\tlet cfg = AppConfig.getInstance();\n\tlet log = Logger.getInstance(cfg.options.logging);\n\tlet outDir = JavascriptUtils.getOutputDir();\n\tlet saydHello = false;\n\tlet session = SessionVars.getInstance();\n\tlet sourceExt =\n\t\tcfg.options.javascript.compiler == ProcessingTypes.typescript ? \".ts\" : \".js\";\n\n\tlet path = join(cfg.dirProject, cfg.options.javascript.dirs.source);\n\tif (!test(\"-e\", path)) {\n\t\tlog.warn(\n\t\t\t`Path ./${\n\t\t\t\tcfg.options.javascript.dirs.source\n\t\t\t} doesn't exist. Request to compile ignored`\n\t\t);\n\t\treturn;\n\t}\n\n\tfunction write(entry: FileStatus) {\n\t\tif (!saydHello && verbose) {\n\t\t\tsaydHello = true;\n\t\t\tlog.info(`Transcompiling ${cfg.options.javascript.compiler}`);\n\t\t}\n\t\tcompileFile(entry, true);\n\t}\n\n\tlet changeList = getChangeList({\n\t\tsourcePath: join(cfg.dirProject, cfg.options.javascript.dirs.source),\n\t\ttargetPath: outDir,\n\t\tsourceExt: [sourceExt],\n\t\ttargetExt: \".js\",\n\t\texcludeList: cfg.options.javascript.removeObsolete.exclude\n\t});\n\tlet processed: string[] = [];\n\n\tchangeList.forEach((entry: FileStatus) => {\n\t\tprocessed.push(entry.target);\n\t\tif (entry.isNewOrModified()) {\n\t\t\tsession.add(\n\t\t\t\tcfg.options.javascript.compiler == \"flow\"\n\t\t\t\t\t? \"javascript\"\n\t\t\t\t\t: cfg.options.javascript.compiler,\n\t\t\t\tentry.source\n\t\t\t);\n\t\t\twrite(entry);\n\t\t}\n\t});\n\n\tJavascriptUtils.bundle().forEach((file: string) => {\n\t\tprocessed.push(file);\n\t});\n\n\tremoveObsolete(\n\t\tcfg.options.javascript.removeObsolete,\n\t\tprocessed,\n\t\toutDir,\n\t\t\".js\"\n\t);\n\n\tif (saydHello && verbose) {\n\t\tTags.forProject(cfg.options.javascript.dirs.source);\n\t\tchangeList.forEach((entry: FileStatus) => {\n\t\t\tif (entry.isNewOrModified()) {\n\t\t\t\tTags.forFile(join(cfg.options.javascript.dirs.source, entry.source));\n\t\t\t}\n\t\t});\n\t\tlog.info(`... done`);\n\t} else if (verbose) {\n\t\tlog.info(`No changed ${cfg.options.javascript.compiler} files found`);\n\t}\n}\n\n/**\n * Compile source file, using the configuration in config.json\n *\n * @returns success\n * @todo Decorators (such as for package json2typescript) don't work yet. Apparently due to bugs in this plugin\n */\nexport function compileFile(\n\tentry: FileStatus,\n\tverbose: boolean = true\n): boolean {\n\tlet cfg = AppConfig.getInstance();\n\tlet log = Logger.getInstance(cfg.options.logging);\n\tlet fullPath = join(entry.dir, entry.source);\n\tlet plugins: any[] = [\n\t\t\"@babel/plugin-proposal-class-properties\",\n\t\t\"@babel/proposal-object-rest-spread\"\n\t];\n\tlet presets: any[] = [];\n\tlet source = FileUtils.readFile(fullPath);\n\n\tif (cfg.options.server.beautify.includes(\"src\")) {\n\t\tsource = Beautify.content(entry.source, source);\n\t\tif (source) {\n\t\t\tFileUtils.writeFile(entry.dir, entry.source, source, false);\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t// In case of certain import statements...\n\tif (source.includes(\"antd\")) {\n\t\t// In case of not using the full, minified antd files:\n\t\t// babel-plugin-import could be used to decrease size of browser bundle.\n\t\t// @dee antd docs, gettng started\n\t\tpresets.push([\"@babel/preset-react\"]); // Using default settings\n\t} else if (source.includes('\"react')) {\n\t\tpresets.push([\"@babel/preset-react\"]); // Using default settings\n\t}\n\n\tif (process.env.NODE_ENV == \"production\") {\n\t\t// For production use\n\t\tpresets.push(\"minify\");\n\t} else if (\n\t\t!dirname(entry.source).includes(\"browser\") &&\n\t\tcfg.options.javascript.sourceMapping\n\t) {\n\t\t// https://www.mattzeunert.com/2016/02/14/how-do-source-maps-work.html\n\t\tplugins.push(\"source-map-support\");\n\t}\n\n\t// @todo Should come BEFORE @babel/plugin-proposal-class-properties\n\t// plugins.push([\n\t// \t\"@babel/plugin-proposal-decorators\",\n\t// \t{\n\t// \t\tdecoratorsBeforeExport: true,\n\t// \t\tlegacy: false\n\t// \t}\n\t// ]);\n\n\tif (cfg.options.javascript.compiler == \"typescript\") {\n\t\tpresets.push(\"@babel/preset-typescript\");\n\t\t// See https://iamturns.com/typescript-babel/\n\t}\n\n\tif (cfg.options.javascript.compiler == \"flow\") {\n\t\tpresets.push(\"@babel/preset-flow\");\n\t}\n\n\tif (dirname(entry.source).includes(\"browser\")) {\n\t\tpresets.push([\n\t\t\t\"@babel/preset-env\",\n\t\t\t{\n\t\t\t\ttargets: cfg.options.javascript.browserTargets\n\t\t\t}\n\t\t]);\n\t} else {\n\t\tpresets.push([\n\t\t\t\"@babel/preset-env\",\n\t\t\t{\n\t\t\t\ttargets: {\n\t\t\t\t\tnode: cfg.options.javascript.nodeVersion\n\t\t\t\t}\n\t\t\t}\n\t\t]);\n\t}\n\n\ttry {\n\t\tlet results: any = transformSync(source, {\n\t\t\tast: true,\n\t\t\tcomments: false,\n\t\t\tfilename: fullPath,\n\t\t\tplugins: plugins,\n\t\t\tpresets: presets,\n\t\t\tsourceMaps: true\n\t\t});\n\t\tif (!results) {\n\t\t\tthrow new Error(\"\");\n\t\t}\n\n\t\tif (process.env.NODE_ENV == \"production\") {\n\t\t\t// For production use\n\t\t\tlet fl = join(entry.targetDir, entry.target + \".ast\");\n\t\t\tif (test(\"-f\", fl)) rm(fl);\n\t\t\tfl = join(entry.targetDir, entry.target + \".map\");\n\t\t\tif (test(\"-f\", fl)) rm(fl);\n\t\t} else if (\n\t\t\t!dirname(entry.source).includes(\"browser\") &&\n\t\t\tcfg.options.javascript.sourceMapping\n\t\t) {\n\t\t\tresults.code += `\\n//# sourceMappingURL=${basename(entry.target)}.map`;\n\t\t\tFileUtils.writeFile(\n\t\t\t\tentry.targetDir,\n\t\t\t\tentry.target + \".map\",\n\t\t\t\tJSON.stringify(results.map),\n\t\t\t\tfalse\n\t\t\t);\n\t\t\tif (cfg.options.javascript.ast)\n\t\t\t\tFileUtils.writeFile(\n\t\t\t\t\tentry.targetDir,\n\t\t\t\t\tentry.target + \".ast\",\n\t\t\t\t\tJSON.stringify(results.ast),\n\t\t\t\t\tfalse\n\t\t\t\t);\n\t\t\t// Working with AST, see\n\t\t\t// https://hackernoon.com/babel-your-first-code-transformations-2d1a9a2f3bc4\n\t\t}\n\n\t\tFileUtils.writeFile(entry.targetDir, entry.target, results.code, verbose);\n\t\t// FileUtils.writeFile(entry.targetDir, entry.target + \".ast\", results.ast, false); // object results.ast needs some work before usable\n\t} catch (err) {\n\t\tlog.warn(\n\t\t\t`- Failed to compile file: ${entry.source}`,\n\t\t\tLogger.error2string(err)\n\t\t);\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n"]}
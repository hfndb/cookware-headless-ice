{"version":3,"sources":["babel.ts"],"names":["compile","verbose","cfg","AppConfig","getInstance","log","Logger","options","logging","outDir","JavascriptUtils","getOutputDir","saydHello","session","SessionVars","sourceExt","javascript","compiler","ProcessingTypes","typescript","path","dirProject","dirs","source","warn","write","entry","info","compileFile","changeList","sourcePath","targetPath","targetExt","excludeList","removeObsolete","exclude","processed","forEach","push","target","isNewOrModified","add","bundle","file","fullPath","dir","plugins","presets","trim","process","env","NODE_ENV","sourceMapping","includes","Object","keys","browserTargets","length","targets","node","nodeVersion","FileUtils","readFile","results","ast","comments","filename","sourceMaps","Error","map","targetDir","code","writeFile","JSON","stringify","err","error2string"],"mappings":"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","sourcesContent":["import { basename, dirname, join } from \"path\";\nimport { grep, rm, test } from \"shelljs\";\nimport { transformSync } from \"@babel/core\";\nimport {\n\tgetChangeList,\n\tAppConfig,\n\tFileStatus,\n\tFileUtils,\n\tLogger\n} from \"../lib\";\nimport { removeObsolete } from \"../lib/files\";\nimport { ProcessingTypes, SessionVars } from \"../sys/session\";\nimport { JavascriptUtils } from \"./javascript\";\n\n// https://babeljs.io/docs/en/\n\n/**\n * Compile changed or new files, create browser bundles\n */\nexport function compile(verbose: boolean): void {\n\tlet cfg = AppConfig.getInstance();\n\tlet log = Logger.getInstance(cfg.options.logging);\n\tlet outDir = JavascriptUtils.getOutputDir();\n\tlet saydHello = false;\n\tlet session = SessionVars.getInstance();\n\tlet sourceExt =\n\t\tcfg.options.javascript.compiler == ProcessingTypes.typescript ? \".ts\" : \".js\";\n\n\tlet path = join(cfg.dirProject, cfg.options.javascript.dirs.source);\n\tif (!test(\"-e\", path)) {\n\t\tlog.warn(\n\t\t\t`Path ./${\n\t\t\t\tcfg.options.javascript.dirs.source\n\t\t\t} doesn't exist. Request to compile ignored`\n\t\t);\n\t\treturn;\n\t}\n\n\tfunction write(entry: FileStatus) {\n\t\tif (!saydHello && verbose) {\n\t\t\tsaydHello = true;\n\t\t\tlog.info(`Transcompiling ${cfg.options.javascript.compiler}`);\n\t\t}\n\t\tcompileFile(entry, true);\n\t}\n\n\tlet changeList = getChangeList({\n\t\tsourcePath: join(cfg.dirProject, cfg.options.javascript.dirs.source),\n\t\ttargetPath: outDir,\n\t\tsourceExt: [sourceExt],\n\t\ttargetExt: \".js\",\n\t\texcludeList: cfg.options.javascript.removeObsolete.exclude\n\t});\n\tlet processed: string[] = [];\n\n\tchangeList.forEach((entry: FileStatus) => {\n\t\tprocessed.push(entry.target);\n\t\tif (entry.isNewOrModified()) {\n\t\t\tsession.add(\n\t\t\t\tcfg.options.javascript.compiler == \"flow\"\n\t\t\t\t\t? \"javascript\"\n\t\t\t\t\t: cfg.options.javascript.compiler,\n\t\t\t\tentry.source\n\t\t\t);\n\t\t\twrite(entry);\n\t\t}\n\t});\n\n\tJavascriptUtils.bundle().forEach((file: string) => {\n\t\tprocessed.push(file);\n\t});\n\n\tremoveObsolete(\n\t\tcfg.options.javascript.removeObsolete,\n\t\tprocessed,\n\t\toutDir,\n\t\t\".js\"\n\t);\n\n\tif (saydHello && verbose) {\n\t\tlog.info(`... done`);\n\t} else if (verbose) {\n\t\tlog.info(`No changed ${cfg.options.javascript.compiler} files found`);\n\t}\n}\n\n/**\n * Compile source file, using the configuration in config.json\n *\n * @returns success\n * @todo Decorators (such as for package json2typescript) don't work yet. Apparently due to bugs in this plugin\n */\nexport function compileFile(\n\tentry: FileStatus,\n\tverbose: boolean = true\n): boolean {\n\tlet cfg = AppConfig.getInstance();\n\tlet log = Logger.getInstance(cfg.options.logging);\n\tlet fullPath = join(entry.dir, entry.source);\n\tlet plugins: any[] = [\n\t\t\"@babel/plugin-proposal-class-properties\",\n\t\t\"@babel/proposal-object-rest-spread\"\n\t];\n\tlet presets: any[] = [];\n\n\tif (grep('from \"react\"', fullPath).trim()) {\n\t\t// Import of react found in source file\n\t\tpresets.push([\"@babel/preset-react\"]); // Using default settings\n\t}\n\n\tif (process.env.NODE_ENV == \"production\") {\n\t\t// For production use\n\t\tpresets.push(\"minify\");\n\t} else if (cfg.options.javascript.sourceMapping) {\n\t\t// https://www.mattzeunert.com/2016/02/14/how-do-source-maps-work.html\n\t\tplugins.push(\"source-map-support\");\n\t}\n\n\t// @todo Should come BEFORE @babel/plugin-proposal-class-properties\n\t// plugins.push([\n\t// \t\"@babel/plugin-proposal-decorators\",\n\t// \t{\n\t// \t\tdecoratorsBeforeExport: true,\n\t// \t\tlegacy: false\n\t// \t}\n\t// ]);\n\n\tif (cfg.options.javascript.compiler == \"typescript\") {\n\t\tpresets.push(\"@babel/preset-typescript\");\n\t\t// See https://iamturns.com/typescript-babel/\n\t}\n\n\tif (cfg.options.javascript.compiler == \"flow\") {\n\t\tpresets.push(\"@babel/preset-flow\");\n\t}\n\n\tif (dirname(entry.source).includes(\"browser\")) {\n\t\tif (Object.keys(cfg.options.javascript.browserTargets).length > 0) {\n\t\t\tpresets.push([\n\t\t\t\t\"@babel/preset-env\",\n\t\t\t\t{\n\t\t\t\t\ttargets: cfg.options.javascript.browserTargets\n\t\t\t\t}\n\t\t\t]);\n\t\t} else {\n\t\t\tpresets.push([\"@babel/preset-env\"]);\n\t\t}\n\t} else {\n\t\tpresets.push([\n\t\t\t\"@babel/preset-env\",\n\t\t\t{\n\t\t\t\ttargets: {\n\t\t\t\t\tnode: cfg.options.javascript.nodeVersion\n\t\t\t\t}\n\t\t\t}\n\t\t]);\n\t}\n\n\tlet source = FileUtils.readFile(fullPath);\n\n\ttry {\n\t\tlet results: any = transformSync(source, {\n\t\t\tast: true,\n\t\t\tcomments: false,\n\t\t\tfilename: fullPath,\n\t\t\tplugins: plugins,\n\t\t\tpresets: presets,\n\t\t\tsourceMaps: true\n\t\t});\n\t\tif (!results) {\n\t\t\tthrow new Error(\"\");\n\t\t}\n\n\t\tif (process.env.NODE_ENV == \"production\") {\n\t\t\t// For production use\n\t\t\tlet map = join(entry.targetDir, entry.target + \".map\");\n\t\t\tif (test(\"-f\", map)) rm(map);\n\t\t} else if (cfg.options.javascript.sourceMapping) {\n\t\t\tresults.code += `\\n//# sourceMappingURL=${basename(entry.target)}.map`;\n\t\t\tFileUtils.writeFile(\n\t\t\t\tentry.targetDir,\n\t\t\t\tentry.target + \".map\",\n\t\t\t\tJSON.stringify(results.map),\n\t\t\t\tfalse\n\t\t\t);\n\t\t}\n\n\t\tFileUtils.writeFile(entry.targetDir, entry.target, results.code, verbose);\n\t\t// FileUtils.writeFile(entry.targetDir, entry.target + \".ast\", results.ast, false); // object results.ast needs some work before usable\n\t} catch (err) {\n\t\tlog.warn(\n\t\t\t`- Failed to compile file: ${entry.source}`,\n\t\t\tLogger.error2string(err)\n\t\t);\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n"]}
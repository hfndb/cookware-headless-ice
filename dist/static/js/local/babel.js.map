{"version":3,"sources":["babel.ts"],"names":["compile","verbose","cfg","AppConfig","getInstance","log","Logger","options","logging","outDir","JavascriptUtils","getOutputDir","saydHello","session","SessionVars","sourceExt","javascript","compiler","ProcessingTypes","typescript","path","dirProject","dirs","source","warn","write","entry","info","compileFile","changeList","sourcePath","targetPath","targetExt","excludeList","removeObsolete","exclude","processed","forEach","push","target","isNewOrModified","add","bundle","file","plugins","presets","compress","sourceMapping","includes","Object","keys","browserTargets","length","targets","node","nodeVersion","FileUtils","readFile","dir","results","ast","comments","filename","sourceMaps","Error","map","targetDir","code","writeFile","JSON","stringify","err","error2string"],"mappings":"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","sourcesContent":["import { basename, dirname, join } from \"path\";\nimport { rm, test } from \"shelljs\";\nimport { transformSync } from \"@babel/core\";\nimport { getChangeList, AppConfig, FileStatus, FileUtils, Logger } from \"../lib\";\nimport { removeObsolete } from \"../lib/files\";\nimport { ProcessingTypes, SessionVars } from \"../sys/session\";\nimport { JavascriptUtils } from \"./javascript\";\n\n// https://babeljs.io/docs/en/\n\n/**\n * Compile changed or new files, create browser bundles\n */\nexport function compile(verbose: boolean): void {\n\tlet cfg = AppConfig.getInstance();\n\tlet log = Logger.getInstance(cfg.options.logging);\n\tlet outDir = JavascriptUtils.getOutputDir();\n\tlet saydHello = false;\n\tlet session = SessionVars.getInstance();\n\tlet sourceExt = cfg.options.javascript.compiler == ProcessingTypes.typescript ? \".ts\" : \".js\";\n\n\tlet path = join(cfg.dirProject, cfg.options.javascript.dirs.source);\n\tif (!test(\"-e\", path)) {\n\t\tlog.warn(`Path ./${cfg.options.javascript.dirs.source} doesn't exist. Request to compile ignored`);\n\t\treturn;\n\t}\n\n\tfunction write(entry: FileStatus) {\n\t\tif (!saydHello && verbose) {\n\t\t\tsaydHello = true;\n\t\t\tlog.info(`Transcompiling ${cfg.options.javascript.compiler}`);\n\t\t}\n\t\tcompileFile(entry, true);\n\t}\n\n\tlet changeList = getChangeList({\n\t\tsourcePath: join(cfg.dirProject, cfg.options.javascript.dirs.source),\n\t\ttargetPath: outDir,\n\t\tsourceExt: [\n\t\t\tsourceExt\n\t\t],\n\t\ttargetExt: \".js\",\n\t\texcludeList: cfg.options.javascript.removeObsolete.exclude\n\t});\n\tlet processed: string[] = [];\n\n\tchangeList.forEach((entry: FileStatus) => {\n\t\tprocessed.push(entry.target);\n\t\tif (entry.isNewOrModified()) {\n\t\t\tsession.add(\n\t\t\t\tcfg.options.javascript.compiler == \"flow\" ? \"javascript\" : cfg.options.javascript.compiler,\n\t\t\t\tentry.source\n\t\t\t);\n\t\t\twrite(entry);\n\t\t}\n\t});\n\n\tJavascriptUtils.bundle().forEach((file: string) => {\n\t\tprocessed.push(file);\n\t});\n\n\tremoveObsolete(cfg.options.javascript.removeObsolete, processed, outDir, \".js\");\n\n\tif (saydHello && verbose) {\n\t\tlog.info(`... done`);\n\t} else if (verbose) {\n\t\tlog.info(`No changed ${cfg.options.javascript.compiler} files found`);\n\t}\n}\n\n/**\n * Compile source file, using the configuration in config.json\n *\n * @returns success\n * @todo Decorators (such as for package json2typescript) don't work yet. Apparently due to bugs in this plugin\n */\nexport function compileFile(entry: FileStatus, verbose: boolean = true): boolean {\n\tlet cfg = AppConfig.getInstance();\n\tlet log = Logger.getInstance(cfg.options.logging);\n\tlet plugins: any[] = [\n\t\t\"@babel/plugin-proposal-class-properties\",\n\t\t\"@babel/proposal-object-rest-spread\"\n\t];\n\tlet presets: any[] = [];\n\n\tif (cfg.options.javascript.compress) {\n\t\t// True if for production use\n\t\tpresets.push(\"minify\");\n\t} else if (cfg.options.javascript.sourceMapping) {\n\t\t// https://www.mattzeunert.com/2016/02/14/how-do-source-maps-work.html\n\t\tplugins.push(\"source-map-support\");\n\t}\n\n\t// @todo Should come BEFORE @babel/plugin-proposal-class-properties\n\t// plugins.push([\n\t// \t\"@babel/plugin-proposal-decorators\",\n\t// \t{\n\t// \t\tdecoratorsBeforeExport: true,\n\t// \t\tlegacy: false\n\t// \t}\n\t// ]);\n\n\tif (cfg.options.javascript.compiler == \"typescript\") {\n\t\tpresets.push(\"@babel/preset-typescript\");\n\t\t// See https://iamturns.com/typescript-babel/\n\t}\n\n\tif (cfg.options.javascript.compiler == \"flow\") {\n\t\tpresets.push(\"@babel/preset-flow\");\n\t}\n\n\tif (dirname(entry.source).includes(\"browser\")) {\n\t\tif (Object.keys(cfg.options.javascript.browserTargets).length > 0) {\n\t\t\tpresets.push([\n\t\t\t\t\"@babel/preset-env\",\n\t\t\t\t{\n\t\t\t\t\ttargets: cfg.options.javascript.browserTargets\n\t\t\t\t}\n\t\t\t]);\n\t\t} else {\n\t\t\tpresets.push([\n\t\t\t\t\"@babel/preset-env\"\n\t\t\t]);\n\t\t}\n\t} else {\n\t\tpresets.push([\n\t\t\t\"@babel/preset-env\",\n\t\t\t{\n\t\t\t\ttargets: {\n\t\t\t\t\tnode: cfg.options.javascript.nodeVersion\n\t\t\t\t}\n\t\t\t}\n\t\t]);\n\t}\n\n\tlet source = FileUtils.readFile(join(entry.dir, entry.source));\n\n\ttry {\n\t\tlet results: any = transformSync(source, {\n\t\t\tast: true,\n\t\t\tcomments: false,\n\t\t\tfilename: join(entry.dir, entry.source),\n\t\t\tplugins: plugins,\n\t\t\tpresets: presets,\n\t\t\tsourceMaps: true\n\t\t});\n\t\tif (!results) {\n\t\t\tthrow new Error(\"\");\n\t\t}\n\n\t\tif (cfg.options.javascript.compress) {\n\t\t\t// For production use\n\t\t\tlet map = join(entry.targetDir, entry.target + \".map\");\n\t\t\tif (test(\"-f\", map)) rm(map);\n\t\t} else if (cfg.options.javascript.sourceMapping) {\n\t\t\tresults.code += `\\n//# sourceMappingURL=${basename(entry.target)}.map`;\n\t\t\tFileUtils.writeFile(entry.targetDir, entry.target + \".map\", JSON.stringify(results.map), false);\n\t\t}\n\n\t\tFileUtils.writeFile(entry.targetDir, entry.target, results.code, verbose);\n\t\t// FileUtils.writeFile(entry.targetDir, entry.target + \".ast\", results.ast, false); // object results.ast needs some work before usable\n\t} catch (err) {\n\t\tlog.warn(`- Failed to compile file: ${entry.source}`, Logger.error2string(err));\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n"]}
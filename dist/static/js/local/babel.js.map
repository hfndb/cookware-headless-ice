{"version":3,"sources":["babel.ts"],"names":["compile","verbose","beautify","cfg","AppConfig","getInstance","log","Logger","options","logging","outDir","JavascriptUtils","getOutputDir","saydHello","session","SessionVars","sourceExt","javascript","compiler","ProcessingTypes","typescript","path","dirProject","dirs","source","warn","write","entry","info","server","includes","compileFile","changeList","sourcePath","targetPath","targetExt","excludeList","removeObsolete","exclude","processed","forEach","push","target","isNewOrModified","add","bundle","file","generateTags","async","fullPath","dir","plugins","presets","trim","process","env","NODE_ENV","sourceMapping","Object","keys","browserTargets","length","targets","node","nodeVersion","FileUtils","readFile","results","ast","comments","filename","sourceMaps","Error","map","targetDir","code","writeFile","JSON","stringify","err","error2string"],"mappings":"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","sourcesContent":["import { basename, dirname, join } from \"path\";\nimport { exec, grep, rm, test } from \"shelljs\";\nimport { transformSync } from \"@babel/core\";\nimport {\n\tgetChangeList,\n\tAppConfig,\n\tFileStatus,\n\tFileUtils,\n\tLogger\n} from \"../lib\";\nimport { removeObsolete } from \"../lib/files\";\nimport { ProcessingTypes, SessionVars } from \"../sys/session\";\nimport { JavascriptUtils } from \"./javascript\";\n\n// https://babeljs.io/docs/en/\n\n/**\n * Compile changed or new files, create browser bundles\n */\nexport function compile(verbose: boolean, beautify: Function): void {\n\tlet cfg = AppConfig.getInstance();\n\tlet log = Logger.getInstance(cfg.options.logging);\n\tlet outDir = JavascriptUtils.getOutputDir();\n\tlet saydHello = false;\n\tlet session = SessionVars.getInstance();\n\tlet sourceExt =\n\t\tcfg.options.javascript.compiler == ProcessingTypes.typescript ? \".ts\" : \".js\";\n\n\tlet path = join(cfg.dirProject, cfg.options.javascript.dirs.source);\n\tif (!test(\"-e\", path)) {\n\t\tlog.warn(\n\t\t\t`Path ./${\n\t\t\t\tcfg.options.javascript.dirs.source\n\t\t\t} doesn't exist. Request to compile ignored`\n\t\t);\n\t\treturn;\n\t}\n\n\tfunction write(entry: FileStatus) {\n\t\tif (!saydHello && verbose) {\n\t\t\tsaydHello = true;\n\t\t\tlog.info(`Transcompiling ${cfg.options.javascript.compiler}`);\n\t\t}\n\t\tif (cfg.options.server.beautify.includes(\"src\")) {\n\t\t\tbeautify(join(cfg.options.javascript.dirs.source, entry.source));\n\t\t}\n\t\tcompileFile(entry, true);\n\t}\n\n\tlet changeList = getChangeList({\n\t\tsourcePath: join(cfg.dirProject, cfg.options.javascript.dirs.source),\n\t\ttargetPath: outDir,\n\t\tsourceExt: [sourceExt],\n\t\ttargetExt: \".js\",\n\t\texcludeList: cfg.options.javascript.removeObsolete.exclude\n\t});\n\tlet processed: string[] = [];\n\n\tchangeList.forEach((entry: FileStatus) => {\n\t\tprocessed.push(entry.target);\n\t\tif (entry.isNewOrModified()) {\n\t\t\tsession.add(\n\t\t\t\tcfg.options.javascript.compiler == \"flow\"\n\t\t\t\t\t? \"javascript\"\n\t\t\t\t\t: cfg.options.javascript.compiler,\n\t\t\t\tentry.source\n\t\t\t);\n\t\t\twrite(entry);\n\t\t}\n\t});\n\n\tJavascriptUtils.bundle().forEach((file: string) => {\n\t\tprocessed.push(file);\n\t});\n\n\tremoveObsolete(\n\t\tcfg.options.javascript.removeObsolete,\n\t\tprocessed,\n\t\toutDir,\n\t\t\".js\"\n\t);\n\n\tif (cfg.options.javascript.generateTags) {\n\t\texec(\n\t\t\t`ctags-exuberant -R  ${join(\n\t\t\t\tcfg.dirProject,\n\t\t\t\tcfg.options.javascript.dirs.source\n\t\t\t)}`,\n\t\t\t{ async: true }\n\t\t);\n\t}\n\n\tif (saydHello && verbose) {\n\t\tlog.info(`... done`);\n\t} else if (verbose) {\n\t\tlog.info(`No changed ${cfg.options.javascript.compiler} files found`);\n\t}\n}\n\n/**\n * Compile source file, using the configuration in config.json\n *\n * @returns success\n * @todo Decorators (such as for package json2typescript) don't work yet. Apparently due to bugs in this plugin\n */\nexport function compileFile(\n\tentry: FileStatus,\n\tverbose: boolean = true\n): boolean {\n\tlet cfg = AppConfig.getInstance();\n\tlet log = Logger.getInstance(cfg.options.logging);\n\tlet fullPath = join(entry.dir, entry.source);\n\tlet plugins: any[] = [\n\t\t\"@babel/plugin-proposal-class-properties\",\n\t\t\"@babel/proposal-object-rest-spread\"\n\t];\n\tlet presets: any[] = [];\n\n\tif (grep('from \"react\"', fullPath).trim()) {\n\t\t// Import of react found in source file\n\t\tpresets.push([\"@babel/preset-react\"]); // Using default settings\n\t}\n\n\tif (process.env.NODE_ENV == \"production\") {\n\t\t// For production use\n\t\tpresets.push(\"minify\");\n\t} else if (cfg.options.javascript.sourceMapping) {\n\t\t// https://www.mattzeunert.com/2016/02/14/how-do-source-maps-work.html\n\t\tplugins.push(\"source-map-support\");\n\t}\n\n\t// @todo Should come BEFORE @babel/plugin-proposal-class-properties\n\t// plugins.push([\n\t// \t\"@babel/plugin-proposal-decorators\",\n\t// \t{\n\t// \t\tdecoratorsBeforeExport: true,\n\t// \t\tlegacy: false\n\t// \t}\n\t// ]);\n\n\tif (cfg.options.javascript.compiler == \"typescript\") {\n\t\tpresets.push(\"@babel/preset-typescript\");\n\t\t// See https://iamturns.com/typescript-babel/\n\t}\n\n\tif (cfg.options.javascript.compiler == \"flow\") {\n\t\tpresets.push(\"@babel/preset-flow\");\n\t}\n\n\tif (dirname(entry.source).includes(\"browser\")) {\n\t\tif (Object.keys(cfg.options.javascript.browserTargets).length > 0) {\n\t\t\tpresets.push([\n\t\t\t\t\"@babel/preset-env\",\n\t\t\t\t{\n\t\t\t\t\ttargets: cfg.options.javascript.browserTargets\n\t\t\t\t}\n\t\t\t]);\n\t\t} else {\n\t\t\tpresets.push([\"@babel/preset-env\"]);\n\t\t}\n\t} else {\n\t\tpresets.push([\n\t\t\t\"@babel/preset-env\",\n\t\t\t{\n\t\t\t\ttargets: {\n\t\t\t\t\tnode: cfg.options.javascript.nodeVersion\n\t\t\t\t}\n\t\t\t}\n\t\t]);\n\t}\n\n\tlet source = FileUtils.readFile(fullPath);\n\n\ttry {\n\t\tlet results: any = transformSync(source, {\n\t\t\tast: true,\n\t\t\tcomments: false,\n\t\t\tfilename: fullPath,\n\t\t\tplugins: plugins,\n\t\t\tpresets: presets,\n\t\t\tsourceMaps: true\n\t\t});\n\t\tif (!results) {\n\t\t\tthrow new Error(\"\");\n\t\t}\n\n\t\tif (process.env.NODE_ENV == \"production\") {\n\t\t\t// For production use\n\t\t\tlet map = join(entry.targetDir, entry.target + \".map\");\n\t\t\tif (test(\"-f\", map)) rm(map);\n\t\t} else if (cfg.options.javascript.sourceMapping) {\n\t\t\tresults.code += `\\n//# sourceMappingURL=${basename(entry.target)}.map`;\n\t\t\tFileUtils.writeFile(\n\t\t\t\tentry.targetDir,\n\t\t\t\tentry.target + \".map\",\n\t\t\t\tJSON.stringify(results.map),\n\t\t\t\tfalse\n\t\t\t);\n\t\t}\n\n\t\tFileUtils.writeFile(entry.targetDir, entry.target, results.code, verbose);\n\t\t// FileUtils.writeFile(entry.targetDir, entry.target + \".ast\", results.ast, false); // object results.ast needs some work before usable\n\t} catch (err) {\n\t\tlog.warn(\n\t\t\t`- Failed to compile file: ${entry.source}`,\n\t\t\tLogger.error2string(err)\n\t\t);\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n"]}
{"version":3,"sources":["pdf.ts"],"names":["renderPdf","cfg","AppConfig","getInstance","log","Logger","options","logging","pdf","firstUpdateWeb","info","SassUtils","compile","content","Content","renderAll","processed","FileUtils","mkdir","dirProject","dirs","output","changeList","sourcePath","getOutputDir","targetPath","sourceExt","targetExt","excludeList","rendering","exclude","flatten","length","saydHello","forEach","entry","isNewOrModified","renderPdfFile","push","target","removeObsolete","fileStatus","retVal","session","SessionVars","cmd","concat","marginLeft","toString","marginRight","dir","source","targetDir","r","stderr","warn","add","ProcessingTypes","sign","err"],"mappings":"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","sourcesContent":["import { basename, join } from \"path\";\nimport { exec } from \"shelljs\";\nimport { getChangeList, AppConfig, FileStatus, FileUtils, Logger } from \"../lib\";\nimport { removeObsolete } from \"../lib/files\";\nimport { Content } from \"../lib/html\";\nimport { signFile } from \"../lib/pgp\";\nimport { ProcessingTypes, SessionVars } from \"../sys/session\";\nimport { compile as compileJs } from \"./babel\";\nimport { SassUtils } from \"./styling\";\n\n/**\n * Render all changed or new PDF files\n * Uses configuration in config.json\n */\nexport function renderPdf(): void {\n\tlet cfg = AppConfig.getInstance();\n\tlet log = Logger.getInstance(cfg.options.logging);\n\n\tif (cfg.options.pdf.firstUpdateWeb) {\n\t\tlog.info(\"Checking (and updating) sources and content\");\n\t\tcompileJs(false);\n\t\tSassUtils.compile(false);\n\n\t\tlet content = new Content();\n\t\tcontent.renderAll(false);\n\t\tlog.info(\"... done\");\n\t}\n\n\tlet processed: string[] = [];\n\n\tFileUtils.mkdir(join(cfg.dirProject, cfg.options.pdf.dirs.output));\n\n\tlet changeList = getChangeList({\n\t\tsourcePath: Content.getOutputDir(),\n\t\ttargetPath: join(cfg.dirProject, cfg.options.pdf.dirs.output),\n\t\tsourceExt: [\n\t\t\t\".html\"\n\t\t],\n\t\ttargetExt: \".pdf\",\n\t\texcludeList: cfg.options.pdf.rendering.exclude,\n\t\tflatten: true\n\t});\n\n\tif (changeList.length == 0) return;\n\n\tlet saydHello = false;\n\tchangeList.forEach((entry: FileStatus) => {\n\t\tif (entry.isNewOrModified()) {\n\t\t\tif (!saydHello) {\n\t\t\t\tsaydHello = true;\n\t\t\t\tlog.info(\"Rendering PDF files\");\n\t\t\t}\n\t\t\trenderPdfFile(entry);\n\t\t}\n\t\tprocessed.push(basename(entry.target));\n\t});\n\n\tremoveObsolete(\n\t\tcfg.options.pdf.rendering.removeObsolete,\n\t\tprocessed,\n\t\tjoin(cfg.dirProject, cfg.options.pdf.dirs.output),\n\t\t\".pdf\"\n\t);\n\n\tif (saydHello) {\n\t\tlog.info(\"... PDF done\");\n\t} else {\n\t\tlog.info(\"No changes in PDF files found\");\n\t}\n}\n\n/**\n * Render PDF file\n *\n * @returns success\n */\nfunction renderPdfFile(fileStatus: FileStatus): boolean {\n\tif (!fileStatus.isNewOrModified()) {\n\t\treturn true;\n\t}\n\n\tlet cfg = AppConfig.getInstance();\n\tlet log = Logger.getInstance(cfg.options.logging);\n\tlet retVal = true;\n\tlet session = SessionVars.getInstance();\n\n\t// Download binary: https://wkhtmltopdf.org/downloads.html\n\tlet cmd = \"wkhtmltopdf -q -s A4 -L \"\n\t\t.concat(cfg.options.pdf.rendering.marginLeft.toString())\n\t\t.concat(\"mm -R \")\n\t\t.concat(cfg.options.pdf.rendering.marginRight.toString())\n\t\t.concat('mm --print-media-type --header-right \"[page] / [toPage]\" ')\n\t\t.concat(join(fileStatus.dir, fileStatus.source))\n\t\t.concat(\" \")\n\t\t.concat(join(fileStatus.targetDir, fileStatus.target));\n\n\ttry {\n\t\tlet r = exec(cmd, {});\n\t\tif (r.stderr) {\n\t\t\tlog.warn(`- Failed to render file: ${fileStatus.target}`); // , r.stderr.toString()\n\t\t\treturn false;\n\t\t}\n\t\tlog.info(`- File written: ${fileStatus.target}`);\n\t\tsession.add(ProcessingTypes.pdf, fileStatus.target);\n\t\tif (cfg.options.pdf.rendering.sign) {\n\t\t\tsignFile(join(cfg.dirProject, fileStatus.target));\n\t\t}\n\t} catch (err) {\n\t\tretVal = false;\n\t}\n\n\treturn retVal;\n}\n"]}
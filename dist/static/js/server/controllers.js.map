{"version":3,"sources":["controllers.ts"],"names":["date","require","controllerSys","req","res","next","cfg","AppConfig","getInstance","root","path","dirMain","controllerGeneric","controllerContent","dirProject","options","html","dirs","content","controllerStatic","file","forceMain","url","startsWith","replace","inProject","Content","getOutputDir","inMain","pdf","output","ePub","epub","sendFile","endsWith","ExpressUtils","logRequest","renderSysTemplate","context","session","SessionVars","entry","FileStatus","setSoure","data","render","dir","source","additionalContext","useProjectTemplates","rendered","forEach","add","ProcessingTypes","send","getCustomContext","javascript","isProject","mw","getAdditionalContext","prefix","concat","ext","toLowerCase","length","substr","Object","assign","systemPackages","projectPackages","md","extractedTitle","frmt","Formatter","reqUrl","query","lint","files","Lint","report","tmp","lastModified","format","Date","set","Pragma","Expires"],"mappings":"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","sourcesContent":["import { basename, extname, join } from \"path\";\nimport { test } from \"shelljs\";\nimport { Response, Request } from \"express\";\nimport { AppConfig } from \"../lib/config\";\nimport { ExpressUtils } from \"../lib/express\";\nimport { FileStatus } from \"../lib/file-diff\";\nimport { Content } from \"../lib/html\";\nimport { getPackageReadmeFiles } from \"../lib/package-json\";\nimport { Formatter } from \"../lib/utils\";\nimport { renderMarkdownFile } from \"../local/markdown\";\nimport { Lint } from \"../local/markup\";\nimport { searchProject } from \"../local/misc\";\nimport { generateStats } from \"../local/overview\";\nimport { ProcessingTypes, SessionVars } from \"../sys/session\";\nconst date = require(\"date-and-time\");\n\n/**\n * For webdev docs and functionality\n */\nexport function controllerSys(req: Request, res: Response, next: Function) {\n\tlet cfg = AppConfig.getInstance();\n\tlet root =\n\t\textname(req.path) == \".md\" ? cfg.dirMain : join(cfg.dirMain, \"content\");\n\tcontrollerGeneric(req, res, next, root, \"/sys\");\n}\n\n/**\n * For project content\n */\nexport function controllerContent(req: Request, res: Response, next: Function) {\n\tlet cfg = AppConfig.getInstance();\n\tlet root =\n\t\textname(req.path) == \".md\"\n\t\t\t? cfg.dirProject\n\t\t\t: join(cfg.dirProject, cfg.options.html.dirs.content);\n\t(async () => {\n\t\tcontrollerGeneric(req, res, next, root, \"\");\n\t})();\n}\n\n/**\n * For static files, in order to see logging at all times.\n * Reason: express.static() only logs errors.\n */\nexport function controllerStatic(req: Request, res: Response, next: Function) {\n\tlet cfg = AppConfig.getInstance();\n\tlet file = basename(req.path);\n\tlet forceMain = false;\n\tlet url = req.path;\n\n\tif (url.startsWith(\"/static/sys\")) {\n\t\turl = url.replace(\"/static/sys\", \"/static\");\n\t\tforceMain = true;\n\t}\n\n\tlet inProject = join(Content.getOutputDir(), url);\n\tlet inMain = join(cfg.dirMain, \"dist\", url);\n\tlet pdf = join(cfg.dirProject, cfg.options.pdf.dirs.output, file);\n\tlet ePub = join(cfg.dirProject, cfg.options.epub.dirs.output, file);\n\n\tif (!forceMain && test(\"-f\", inProject)) {\n\t\tres.sendFile(inProject);\n\t} else if (test(\"-f\", inMain)) {\n\t\tres.sendFile(inMain);\n\t} else if (req.path.endsWith(\".epub\") && test(\"-f\", ePub)) {\n\t\tExpressUtils.logRequest(req, res); // @todo obsolete?\n\t\tres.sendFile(ePub);\n\t} else if (req.path.endsWith(\".pdf\") && test(\"-f\", pdf)) {\n\t\tExpressUtils.logRequest(req, res); // @todo obsolete?\n\t\tres.sendFile(pdf);\n\t} else {\n\t\tnext();\n\t}\n}\n\nfunction renderSysTemplate(res: Response, path: string, context: object) {\n\tlet cfg = AppConfig.getInstance();\n\tlet content = new Content();\n\tlet session = SessionVars.getInstance();\n\n\tlet entry = new FileStatus(join(cfg.dirMain, \"content\"));\n\tentry.setSoure(path, \".html\");\n\tlet data = content.render(entry.dir, entry.source, {\n\t\tadditionalContext: context,\n\t\tuseProjectTemplates: false\n\t});\n\tcontent.rendered.forEach(file => {\n\t\tsession.add(ProcessingTypes.html, file);\n\t});\n\n\tres.send(data);\n}\n\nasync function getCustomContext(\n\treq: Request,\n\tres: Response,\n\tdir: string,\n\turl: string\n): Promise<Object> {\n\tlet cfg = AppConfig.getInstance();\n\tlet file = join(\n\t\tcfg.dirProject,\n\t\tcfg.options.javascript.dirs.output,\n\t\t\"server\",\n\t\t\"data-provider.js\"\n\t);\n\tif (!cfg.isProject) return {};\n\tif (cfg.isProject && !test(\"-f\", file)) return {};\n\n\t// const resolved = require.resolve(file);\n\tconst mw = require(file); // Dynamically load\n\treturn await mw.getAdditionalContext(req, res, dir, url, cfg);\n}\n\nasync function controllerGeneric(\n\treq: Request,\n\tres: Response,\n\tnext: Function,\n\tdir: string,\n\tprefix: string\n) {\n\tlet cfg = AppConfig.getInstance();\n\tlet content = new Content();\n\tlet session = SessionVars.getInstance();\n\n\tlet additionalContext: object[] = [];\n\tlet url = req.path.endsWith(\"/\") ? req.path.concat(\"index.html\") : req.path;\n\tlet ext = extname(url).toLowerCase();\n\n\tif (prefix.length > 0) {\n\t\t// Strip prefix\n\t\turl = url.substr(prefix.length);\n\t}\n\turl = url.substr(1); // strip leading \"/\" from URL path\n\n\tif (prefix == \"/sys\" && ext == \".html\") {\n\t\tdir = join(cfg.dirMain, \"content\");\n\t}\n\tif (!test(\"-e\", join(dir, url))) {\n\t\tnext();\n\t\treturn;\n\t}\n\n\tif (prefix == \"/sys\" && url == \"index.html\") {\n\t\tadditionalContext = Object.assign(additionalContext, {\n\t\t\tisProject: cfg.isProject,\n\t\t\tsystemPackages: getPackageReadmeFiles(true),\n\t\t\tprojectPackages: getPackageReadmeFiles(false)\n\t\t});\n\t}\n\n\tswitch (ext) {\n\t\tcase \".md\":\n\t\t\tlet md = renderMarkdownFile(dir, url);\n\n\t\t\tadditionalContext = Object.assign(additionalContext, {\n\t\t\t\textractedTitle: md[1],\n\t\t\t\trendered: md[0]\n\t\t\t});\n\t\t\t// Render retrieved content in a HTML template, so no break here\n\t\t\tdir = join(cfg.dirMain, \"content\");\n\t\t\turl = \"markdown.html\";\n\t\tcase \".html\":\n\t\t\tlet data = \"\";\n\t\t\tlet entry: FileStatus;\n\t\t\tlet context = {\n\t\t\t\tfrmt: Formatter.getInstance(),\n\t\t\t\treqUrl: req.url\n\t\t\t};\n\t\t\tcontext = Object.assign(context, additionalContext);\n\n\t\t\tif (ext != \".md\" && req.query && req.query.lint) {\n\t\t\t\tcontext = Object.assign(context, {\n\t\t\t\t\tfiles: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tfile: url,\n\t\t\t\t\t\t\toutput: Lint.file(\n\t\t\t\t\t\t\t\tjoin(cfg.dirProject, cfg.options.html.dirs.content, url),\n\t\t\t\t\t\t\t\ttrue\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t});\n\t\t\t\trenderSysTemplate(res, \"lint.html\", context);\n\t\t\t} else if (url == \"todo.html\") {\n\t\t\t\tcontext = Object.assign(context, searchProject(\"todo\", true));\n\t\t\t\trenderSysTemplate(res, \"todo.html\", context);\n\t\t\t} else if (url == \"project-overview.html\") {\n\t\t\t\tcontext = Object.assign(context, { report: generateStats() });\n\t\t\t\trenderSysTemplate(res, \"project-overview.html\", context);\n\t\t\t} else {\n\t\t\t\tlet tmp = await getCustomContext(req, res, dir, url);\n\t\t\t\tif (tmp == null) {\n\t\t\t\t\tExpressUtils.logRequest(req, res);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tcontext = Object.assign(context, tmp);\n\n\t\t\t\t// Prevent browser caching\n\t\t\t\tlet lastModified = date.format(\n\t\t\t\t\tnew Date(),\n\t\t\t\t\t\"ddd, DD MMM YYYY hh:mm:00 [GMT]\"\n\t\t\t\t); // Sun, 22 Sep 2019 10:13:00 GMT\n\t\t\t\tres.set({\n\t\t\t\t\tPragma: \"public\",\n\t\t\t\t\t\"Last-Modified\": lastModified,\n\t\t\t\t\tExpires: \"Mon, 26 Jul 1997 05:00:00 GMT\",\n\t\t\t\t\t\"Cache-Control\":\n\t\t\t\t\t\t\"no-cache, no-store, must-revalidate, post-check=0, pre-check=0, private\"\n\t\t\t\t});\n\n\t\t\t\tentry = new FileStatus(dir);\n\t\t\t\tentry.setSoure(url, \".html\");\n\t\t\t\tdata = content.render(entry.dir, entry.source, {\n\t\t\t\t\tadditionalContext: context,\n\t\t\t\t\tuseProjectTemplates: ext != \".md\" && prefix != \"/sys\"\n\t\t\t\t});\n\t\t\t\tcontent.rendered.forEach(file => {\n\t\t\t\t\tsession.add(ProcessingTypes.html, file);\n\t\t\t\t});\n\t\t\t\tres.send(data);\n\t\t\t\tbreak;\n\t\t\t}\n\t}\n\tnext();\n}\n"]}
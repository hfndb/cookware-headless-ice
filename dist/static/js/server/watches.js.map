{"version":3,"sources":["watches.ts"],"names":["Double","is","file","interval","now","Date","getTime","last","reg","ConfigWatch","FileWatcher","change","event","cfg","AppConfig","getInstance","log","Logger","read","info","CssWatch","dirProject","options","sass","dirs","source","SassUtils","getOutputDir","SassWatch","session","SessionVars","add","ProcessingTypes","startsWith","compile","status","FileStatus","setSoure","setTarget","compileFile","JsWatch","dir","javascript","isTypescript","output","compiler","typescript","JavascriptUtils","bundle","generateTags","async"],"mappings":"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","sourcesContent":["import { basename, extname, join } from \"path\";\nimport { cp, exec, grep } from \"shelljs\";\nimport { FileWatcher, FileStatus, Logger } from \"../lib\";\nimport { AppConfig } from \"../lib/config\";\nimport { compileFile } from \"../local/babel\";\nimport { JavascriptUtils } from \"../local/javascript\";\nimport { SassUtils } from \"../local/styling\";\nimport { ProcessingTypes, SessionVars } from \"../sys/session\";\n\n/**\n * Safety for beautifying files. Block files just beautified\n */\nclass Double {\n\tstatic _instance: Double;\n\tstatic reg: { [key: string]: number } = {};\n\n\tstatic is(file: string): boolean {\n\t\tlet interval = 1 * 2000; // Assume max. 2 sec. to beautify\n\t\tlet now = new Date().getTime();\n\t\tlet last = Double.reg[file] || now - interval - 10;\n\n\t\tif (now - last > interval) {\n\t\t\tDouble.reg[file] = now;\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n}\n\nexport class ConfigWatch extends FileWatcher {\n\tstatic instance: ConfigWatch;\n\n\tpublic change(event: string, file: string): void {\n\t\tlet cfg = AppConfig.getInstance();\n\t\tlet log = Logger.getInstance();\n\t\tevent; // Fool compiler - unused variable\n\t\tfile;\n\t\tcfg.read();\n\t\tlog.info(`- config.json changed and reloaded`);\n\t}\n}\n\nexport class CssWatch extends FileWatcher {\n\tstatic instance: CssWatch;\n\n\tpublic change(event: string, file: string): void {\n\t\tevent; // Fool compiler - unused variable\n\t\tif (extname(file) != \".css\") {\n\t\t\treturn;\n\t\t}\n\t\tlet cfg = AppConfig.getInstance();\n\t\tlet log = Logger.getInstance();\n\t\tlog.info(`- ${file} changed`);\n\t\tcp(\n\t\t\tjoin(cfg.dirProject, cfg.options.sass.dirs.source, file),\n\t\t\tSassUtils.getOutputDir()\n\t\t);\n\t}\n}\n\nexport class SassWatch extends FileWatcher {\n\tstatic instance: SassWatch;\n\n\tpublic change(event: string, file: string): void {\n\t\tlet cfg = AppConfig.getInstance();\n\t\tlet log = Logger.getInstance();\n\t\tevent; // Fool compiler - unused variable\n\t\tif (extname(file) != \".scss\") {\n\t\t\treturn;\n\t\t}\n\t\tif (Double.is(file)) return;\n\t\tlog.info(`- ${file} changed`);\n\n\t\tlet session = SessionVars.getInstance();\n\t\tsession.add(ProcessingTypes.sass, file);\n\n\t\tif (basename(file, \".scss\").startsWith(\"_\")) {\n\t\t\t// Mixin, compile everything\n\t\t\tSassUtils.compile(true);\n\t\t} else {\n\t\t\tlet status = new FileStatus(\n\t\t\t\tjoin(cfg.dirProject, cfg.options.sass.dirs.source)\n\t\t\t);\n\t\t\tstatus.setSoure(file, \".scss\");\n\t\t\tstatus.setTarget(SassUtils.getOutputDir(), \".css\");\n\t\t\tSassUtils.compileFile(status);\n\t\t}\n\t}\n}\n\nexport class JsWatch extends FileWatcher {\n\tstatic instance: JsWatch;\n\n\tpublic change(event: string, file: string): void {\n\t\tevent; // Fool compiler - unused variable\n\t\tif (extname(file) != \".js\" && extname(file) != \".ts\") {\n\t\t\treturn;\n\t\t}\n\t\tif (Double.is(file)) return;\n\t\tlet cfg = AppConfig.getInstance();\n\t\tlet log = Logger.getInstance();\n\t\tlog.info(`- ${file} changed`);\n\t\tlet dir = join(cfg.dirProject, cfg.options.javascript.dirs.source);\n\n\t\tlet isTypescript = extname(file) == \".ts\";\n\t\tlet status = new FileStatus(dir);\n\t\tstatus.setSoure(file, isTypescript ? \".ts\" : \".js\");\n\t\tstatus.setTarget(\n\t\t\tjoin(cfg.dirProject, cfg.options.javascript.dirs.output),\n\t\t\t\".js\"\n\t\t);\n\n\t\tswitch (cfg.options.javascript.compiler) {\n\t\t\tcase \"\":\n\t\t\t\tcp(\n\t\t\t\t\tjoin(dir, file),\n\t\t\t\t\tjoin(cfg.dirProject, cfg.options.javascript.dirs.output, file)\n\t\t\t\t);\n\t\t\tdefault:\n\t\t\t\tlet session = SessionVars.getInstance();\n\t\t\t\tsession.add(\n\t\t\t\t\tisTypescript ? ProcessingTypes.typescript : ProcessingTypes.javascript,\n\t\t\t\t\tfile\n\t\t\t\t);\n\t\t\t\tcompileFile(status, true);\n\t\t\t\tJavascriptUtils.bundle();\n\t\t\t\tif (cfg.options.javascript.generateTags) {\n\t\t\t\t\texec(\n\t\t\t\t\t\t`ctags-exuberant --fields=nksSaf --file-scope=yes -R  ${join(\n\t\t\t\t\t\t\tcfg.dirProject,\n\t\t\t\t\t\t\tcfg.options.javascript.dirs.source\n\t\t\t\t\t\t)}`,\n\t\t\t\t\t\t{ async: true }\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t}\n\t}\n}\n"]}